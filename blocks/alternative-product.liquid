{% assign alt_product = product.metafields.custom.alternative_product.value %}
{% assign image = alt_product.featured_image %}

<h4>{{ block.settings.title }}</h4>
<div class="alternative-product" style="gap: {{ block.settings.gap_size }}px;">
  <img
    src="{{ image | image_url: original }}"
    alt="{{ alt_product.title }}"
    style="width: {% if block.settings.image_width %}{{ block.settings.image_width }}{% else %}100%{% endif %}; height: auto;"
  >

  <h5 class="product-title">
    <a href="{{ alt_product.url }}" class="link">{{ alt_product.title }}</a>
  </h5>

  <h6 class="product-price">{{ alt_product.price | money }}</h6>

  <div class="product-action-row">
    {% if alt_product.variants.size > 1 %}
      <select name="variant_select" class="custom-select" id="alt-product-select-{{ section.id }}">
        {% for variant in alt_product.variants %}
          <option value="{{ variant.id }}">{{ variant.title }} â€“ {{ variant.price | money }}</option>
        {% endfor %}
      </select>
    {% endif %}

    <button
      data-product-id="{{ alt_product.id }}"
      class="button add-to-cart-btn"
      data-section-id="{{ section.id }}"
    >
      <span class="add-to-cart-text"> Add to cart</span>
    </button>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const button = document.querySelector('.add-to-cart-btn[data-section-id="{{ section.id }}"]');
    if (!button) return;

    const buttonTextElem = button.querySelector('.add-to-cart-text');
    const select = document.getElementById('alt-product-select-{{ section.id }}');
    let lastAddedVariantId = null;

    button.addEventListener('click', async function() {
      if (!select && button.disabled) return;
      let variantId = select ? select.value : {{ alt_product.variants.first.id }};

      try {
        const addResponse = await fetch('/cart/add.js', {
          method: 'POST',
          headers: {'Content-Type': 'application/json','Accept': 'application/json'},
          body: JSON.stringify({id: variantId, quantity: 1})
        });
        const addedItem = await addResponse.json();

        const cartResponse = await fetch('/cart.js');
        const cart = await cartResponse.json();
        const cartCountElem = document.querySelector('.cart-bubble__text');
        if (cartCountElem) cartCountElem.textContent = cart.item_count;

        if (buttonTextElem) buttonTextElem.textContent = 'Added';
        button.disabled = true;
        lastAddedVariantId = variantId;

      } catch (error) {
        console.error('Error adding to cart:', error);
      }
    });

    if (select) {
      select.addEventListener('change', function() {
        if (lastAddedVariantId !== select.value) {
          button.disabled = false;
          if (buttonTextElem) buttonTextElem.textContent = 'Add to cart';
        }
      });
    }
  });
</script>

{% schema %}
{
  "name": "Alternative product",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Alternative product"
    },
    {
      "type": "number",
      "id": "gap_size",
      "label": "Gap between elements",
      "default": 8
    },
    {
      "type": "text",
      "id": "image_width",
      "label": "Image width",
      "default": "100%"
    }
  ],
  "presets": [{ "name": "Alternative product" }]
}
{% endschema %}

{% stylesheet %}
  .alternative-product {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .alternative-product img {
    margin-bottom: 8px;
    height: auto;
  }
  .product-title,
  .product-price {
    margin: 0;
  }

  .product-action-row {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .custom-select {
    flex: 1;
    padding: 15px 15px;
    border-radius: 8px;
    border: 1px solid #ccc;
    background-color: #fff;
    font-size: 16px;
    cursor: pointer;
  }
  .add-to-cart-text {
    width: max-content;
  }
{% endstylesheet %}
